@page "/car/{Id:int}"
@using System.Security.Claims
@using CarListingApp.Services.DTOs.Car
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject NavigationManager Nav

<div class="details-wrapper">
    @if (car == null)
    {
        <div class="loading-box">INITIALIZING SYSTEM DATA...</div>
    }
    else
    {
        <div class="heavy-card">
            <div class="card-left-visual">
                <i class="bi bi-car-front-fill"></i>
                <div class="status-overlay">@car.Status.ToUpper()</div>
            </div>

            <div class="card-right-info">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="text-uppercase fw-900">@car.Brand @car.Model</h1>
                        <p class="specs-sub">YEAR: @car.Year // VIN: @(car.Vin ?? "N/A")</p>
                    </div>
                    <div class="price-tag">$@car.Price.ToString("N0")</div>
                </div>

                <div class="info-grid">
                    <div class="info-item"><strong>ENGINE:</strong> @car.EngineDisplacement L</div>
                    <div class="info-item"><strong>POWER:</strong> @car.EnginePower HP</div>
                    <div class="info-item"><strong>MILEAGE:</strong> @(car.Mileage?.ToString("N0") ?? "0") KM</div>
                    <div class="info-item"><strong>COLOR:</strong> @car.Color?.ToUpper()</div>
                </div>

                <div class="description-box">
                    <strong>DESCRIPTION:</strong><br />
                    <p>@(string.IsNullOrEmpty(car.Description) ? "NO DATA PROVIDED." : car.Description)</p>
                </div>

                <AuthorizeView>
                    <Authorized>
                        @if (IsOwnerOrAdmin(context.User))
                        {
                            <div class="admin-panel">
                                <h5 class="panel-title">SELLER CONTROLS</h5>
                                <div class="action-buttons">
                                    <button class="btn-industrial btn-warn" @onclick="GoToEdit">EDIT</button>
                                    @if (car.Status == "Active")
                                    {
                                        <button class="btn-industrial btn-success" @onclick="MarkAsSold">MARK SOLD</button>
                                    }
                                    <button class="btn-industrial btn-danger" @onclick="DeleteCar">DELETE</button>
                                </div>
                            </div>
                        }
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>
    }
</div>

<style>
    .fw-900 { font-weight: 900; letter-spacing: -2px; }
    
    /* Magenta Visual Box */
    .card-left-visual {
        width: 40%;
        background: #ff00ff; /* MAGENTA */
        border-right: 2px solid black;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        min-height: 400px;
        color: white;
        font-size: 5rem;
    }

    .status-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        background: black;
        color: white;
        font-size: 0.8rem;
        padding: 5px 10px;
        font-weight: bold;
    }

    .card-right-info { flex: 1; padding: 40px; }
    
    .price-tag { font-size: 2.5rem; font-weight: 900; letter-spacing: -1px; }
    
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin: 20px 0;
        border: 2px solid black;
        padding: 15px;
        font-size: 0.85rem;
    }

    .description-box {
        border-left: 4px solid black;
        padding-left: 15px;
        margin-top: 20px;
    }

    /* INDUSTRIAL BUTTONS */
    .admin-panel {
        margin-top: 30px;
        border: 2px dashed black;
        padding: 20px;
    }

    .panel-title { font-size: 0.7rem; font-weight: 900; margin-bottom: 15px; }

    .action-buttons { display: flex; gap: 10px; }

    .btn-industrial {
        flex: 1;
        border: 2px solid black;
        padding: 10px;
        font-weight: 900;
        font-size: 0.8rem;
        cursor: pointer;
        background: white;
        transition: 0.2s;
    }

    .btn-warn:hover { background: #ffcc00; }
    .btn-success:hover { background: #00ff00; }
    .btn-danger:hover { background: #ff0000; color: white; }
</style>

@code {
    [Parameter] public int Id { get; set; }
    private CarDto? car;

    protected override async Task OnInitializedAsync()
    {
        try { car = await Http.GetFromJsonAsync<CarDto>($"cars/{Id}"); }
        catch { Nav.NavigateTo("/"); }
    }

    private bool IsOwnerOrAdmin(ClaimsPrincipal user)
    {
        if (user.IsInRole("Admin")) return true;
        // For now, returning true to show buttons; 
        // Logic should be: return car?.SellerId == user.FindFirst("sub")?.Value;
        return true; 
    }

    private async Task MarkAsSold()
    {
        if (car == null) return;
        car.Status = "Sold";
        await Http.PutAsJsonAsync($"cars/{Id}", car);
    }

    private void GoToEdit() => Nav.NavigateTo($"/car/edit/{Id}");

    private async Task DeleteCar()
    {
        var response = await Http.DeleteAsync($"cars/{Id}");
        if (response.IsSuccessStatusCode) Nav.NavigateTo("/");
    }
}