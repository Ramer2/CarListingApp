@page "/login"
@using Blazored.LocalStorage
@using CarListingApp.Client.Auth
@using CarListingApp.Services.DTOs.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<div style="max-width: 450px; margin: 5rem auto;">
    <div class="heavy-card" style="flex-direction: column; background: white;">
        <div style="background: black; color: white; padding: 20px; text-align: center;">
            <h2 class="fw-900" style="margin: 0; letter-spacing: 2px;">ACCESS_LOGIN</h2>
        </div>
        
        <div style="padding: 40px;">
            <EditForm Model="_loginModel" OnValidSubmit="HandleLogin">
                <div class="input-group mb-4">
                    <label style="font-weight: 900; font-size: 0.7rem;">IDENTIFIER (EMAIL/USER)</label>
                    <input @bind="_identifier" class="custom-input" style="width: 100%;" />
                </div>

                <div class="input-group mb-4">
                    <label style="font-weight: 900; font-size: 0.7rem;">PASSWORD</label>
                    <input @bind="_loginModel.Password" type="password" class="custom-input" style="width: 100%;" />
                </div>

                <button type="submit" class="btn-black" style="width: 100%; padding: 15px;">INITIALIZE_SESSION</button>
            </EditForm>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="/register" style="font-size: 0.7rem; color: #888; text-decoration: none;">REQUEST_NEW_ACCOUNT</a>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginUserDto _loginModel = new();
    private string _identifier;

    private async Task HandleLogin()
    {
        // Simple logic to determine if input is email or username
        if (_identifier.Contains("@")) _loginModel.Email = _identifier;
        else _loginModel.Username = _identifier;

        var response = await Http.PostAsJsonAsync("login", _loginModel);
        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<TokenDto>();
            await LocalStorage.SetItemAsync("authToken", result.AccessToken);
            ((CustomAuthStateProvider)AuthStateProvider).NotifyUserAuthentication(result.AccessToken);
            Nav.NavigateTo("/");
        }
    }
}