@page "/login"
@using Blazored.LocalStorage
@using CarListingApp.Client.Auth
@using CarListingApp.Services.DTOs.Auth
@using Microsoft.AspNetCore.Components.Authorization
@inject HttpClient Http
@inject ILocalStorageService LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<div style="max-width: 450px; margin: 5rem auto;">
    <div class="heavy-card" style="flex-direction: column; background: white;">
        <div style="background: black; color: white; padding: 25px; text-align: center;">
            <h2 class="fw-900" style="margin: 0; letter-spacing: 2px;">ACCESS_LOGIN</h2>
        </div>
        
        <div style="padding: 40px; display: flex; flex-direction: column; gap: 30px;">
            
            @if (!string.IsNullOrEmpty(_userErrorMessage))
            {
                <div style="border: 2px solid #ff0055; background: #fff5f7; color: #ff0055; padding: 15px; font-weight: 900; font-size: 0.75rem;">
                    [ACCESS_DENIED]: @_userErrorMessage.ToUpper()
                </div>
            }

            <EditForm Model="_loginModel" OnValidSubmit="HandleLogin" style="display: flex; flex-direction: column; gap: 20px;">
                <div class="input-group">
                    <label style="font-weight: 900; font-size: 0.7rem; margin-bottom: 8px; display: block;">IDENTIFIER (EMAIL/USER)</label>
                    <input @bind="_identifier" class="custom-input" style="width: 100%;" placeholder="ENTRY_ID" />
                </div>

                <div class="input-group">
                    <label style="font-weight: 900; font-size: 0.7rem; margin-bottom: 8px; display: block;">PASSWORD</label>
                    <input @bind="_loginModel.Password" type="password" class="custom-input" style="width: 100%;" placeholder="••••••••" />
                </div>

                <button type="submit" class="btn-black" style="width: 100%; padding: 18px; margin-top: 10px;" disabled="@_isProcessing">
                    @(_isProcessing ? "SYNCHRONIZING..." : "INITIALIZE_SESSION")
                </button>
            </EditForm>
            
            <div style="text-align: center;">
                <a href="/register" style="font-size: 0.7rem; color: #888; text-decoration: none; font-weight: bold;">REQUEST_NEW_ACCOUNT</a>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginUserDto _loginModel = new();
    private string _identifier = "";
    private string? _userErrorMessage;
    private bool _isProcessing;

    private bool ValidateData()
    {
        if (string.IsNullOrWhiteSpace(_identifier))
        {
            _userErrorMessage = "IDENTIFIER_FIELD_CANNOT_BE_EMPTY";
            return false;
        }
        if (string.IsNullOrWhiteSpace(_loginModel.Password) || _loginModel.Password.Length < 4)
        {
            _userErrorMessage = "PASSWORD_STRENGTH_INSUFFICIENT";
            return false;
        }
        return true;
    }

    private async Task HandleLogin()
    {
        _isProcessing = true;
        _userErrorMessage = null;

        if (!ValidateData())
        {
            _isProcessing = false;
            return;
        }

        try 
        {
            if (_identifier.Contains("@")) _loginModel.Email = _identifier;
            else _loginModel.Username = _identifier;

            var response = await Http.PostAsJsonAsync("api/auth/login", _loginModel);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<TokenDto>();
                await LocalStorage.SetItemAsync("authToken", result!.AccessToken);
                ((CustomAuthStateProvider)AuthStateProvider).NotifyUserAuthentication(result.AccessToken);
                Nav.NavigateTo("/");
            }
            else
            {
                _userErrorMessage = "Invalid credentials. Access to the central database was rejected.";
            }
        }
        catch 
        {
            _userErrorMessage = "Critical connection error. Ensure your link to the terminal is stable.";
        }
        finally 
        {
            _isProcessing = false;
        }
    }
}