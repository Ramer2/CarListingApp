@page "/register"
@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject NavigationManager Nav

<div style="max-width: 500px; margin: 3rem auto;">
    <div class="heavy-card" style="flex-direction: column; background: white;">
        <div style="padding: 40px;">
            <h2 style="font-weight: 900; text-transform: uppercase; margin-bottom: 2rem; letter-spacing: -1px;">CREATE_NEW_PROTOCOL</h2>
            
            @if (!string.IsNullOrEmpty(_userErrorMessage))
            {
                <div style="color: #ff0055; border: 2px solid #ff0055; padding: 15px; margin-bottom: 2rem; font-size: 0.75rem; font-weight: 900; background: #fff5f7;">
                    [REGISTRATION_REJECTED]: @_userErrorMessage.ToUpper()
                </div>
            }

            <EditForm Model="_regModel" OnValidSubmit="HandleRegister" style="display: flex; flex-direction: column; gap: 20px;">
                <DataAnnotationsValidator />

                @* ROLE SELECTION *@
                <div>
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 12px;">ACCOUNT_TYPE</label>
                    <div style="display: flex; gap: 30px;">
                        <label class="radio-container">
                            <input type="radio" name="role" value="User" checked="@(_regModel.RoleName == "User")" @onchange="@(() => _regModel.RoleName = "User")" />
                            <span class="custom-radio"></span> INDIVIDUAL
                        </label>
                        <label class="radio-container">
                            <input type="radio" name="role" value="Dealer" checked="@(_regModel.RoleName == "Dealer")" @onchange="@(() => _regModel.RoleName = "Dealer")" />
                            <span class="custom-radio"></span> DEALER
                        </label>
                    </div>
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">USERNAME</label>
                    <input @bind="_regModel.Username" class="custom-input" placeholder="ALPHA_USER_01" />
                    <ValidationMessage For="@(() => _regModel.Username)" class="user-error" />
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">EMAIL_ADDRESS</label>
                    <input @bind="_regModel.Email" type="email" class="custom-input" placeholder="user@domain.com" />
                    <ValidationMessage For="@(() => _regModel.Email)" class="user-error" />
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">SECURITY_KEY (PASSWORD)</label>
                    <input @bind="_regModel.Password" type="password" class="custom-input" placeholder="••••••••" />
                    <ValidationMessage For="@(() => _regModel.Password)" class="user-error" />
                </div>

                <button type="submit" class="btn-black" style="margin-top: 10px; padding: 18px;">EXECUTE_REGISTRATION</button>
            </EditForm>
        </div>

        <div style="background: #fafafa; border-top: 2px solid black; padding: 20px; text-align: center;">
            <p style="font-size: 0.7rem; margin: 0; font-weight: 700;">ALREADY REGISTERED? <a href="login" style="color: #ff00ff; text-decoration: none;">SIGN_IN</a></p>
        </div>
    </div>
</div>

<style>
    .user-error { color: #ff0055; font-size: 0.65rem; font-weight: 900; margin-top: 5px; display: block; text-transform: uppercase; }
</style>

@code {
    private RegisterDto _regModel = new() { RoleName = "User" };
    private string? _userErrorMessage;

    private bool ValidateData()
    {
        if (string.IsNullOrWhiteSpace(_regModel.Username) || _regModel.Username.Length < 3)
        {
            _userErrorMessage = "VALIDATION_ERROR: USERNAME_INSUFFICIENT_LENGTH";
            return false;
        }

        if (string.IsNullOrWhiteSpace(_regModel.Email) || !_regModel.Email.Contains("@"))
        {
            _userErrorMessage = "VALIDATION_ERROR: INVALID_EMAIL_STRUCTURE";
            return false;
        }

        if (string.IsNullOrWhiteSpace(_regModel.Password) || _regModel.Password.Length < 6)
        {
            _userErrorMessage = "VALIDATION_ERROR: SECURITY_KEY_STRENGTH_LOW";
            return false;
        }

        if (string.IsNullOrWhiteSpace(_regModel.RoleName))
        {
            _userErrorMessage = "VALIDATION_ERROR: ACCOUNT_TYPE_NOT_DEFINED";
            return false;
        }

        return true;
    }

    private async Task HandleRegister()
    {
        _userErrorMessage = null;

        if (!ValidateData())
        {
            return;
        }

        try 
        {
            var response = await Http.PostAsJsonAsync("api/users", _regModel);
            if (response.IsSuccessStatusCode) Nav.NavigateTo("/login");
            else _userErrorMessage = "Information rejected. Possible duplicate identifier or weak password.";
        }
        catch 
        {
            _userErrorMessage = "Terminal failure. Unable to reach registration server.";
        }
    }

    public class RegisterDto {
        [Required] public string Username { get; set; } = "";
        [Required, EmailAddress] public string Email { get; set; } = "";
        [Required, MinLength(6)] public string Password { get; set; } = "";
        public string RoleName { get; set; } = "";
    }
}