@page "/register"
@using CarListingApp.Models.Models.Enums
@using System.ComponentModel.DataAnnotations
@using CarListingApp.Services.DTOs.User
@inject HttpClient Http
@inject NavigationManager Nav

<div style="max-width: 500px; margin: 3rem auto;">
    <div class="heavy-card" style="flex-direction: column; background: white;">
        <div style="padding: 40px;">
            <h2 style="font-weight: 900; text-transform: uppercase; margin-bottom: 2rem; letter-spacing: -1px;">CREATE_NEW_PROTOCOL</h2>
            
            @if (!string.IsNullOrEmpty(_userErrorMessage))
            {
                <div style="color: #ff0055; border: 2px solid #ff0055; padding: 15px; margin-bottom: 2rem; font-size: 0.75rem; font-weight: 900; background: #fff5f7;">
                    [REGISTRATION_REJECTED]: @_userErrorMessage.ToUpper()
                </div>
            }

            <EditForm Model="_regModel" OnValidSubmit="HandleRegister" style="display: flex; flex-direction: column; gap: 20px;">
                <DataAnnotationsValidator />

                @* ROLE SELECTION USING ENUM *@
                <div>
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 12px;">ACCOUNT_TYPE</label>
                    <div style="display: flex; gap: 30px;">
                        <label class="radio-container" style="cursor: pointer; font-weight: 700; font-size: 0.8rem;">
                            <input type="radio" name="role" 
                                   checked="@(_regModel.Role == RolesEnum.User)" 
                                   @onchange="@(() => _regModel.Role = RolesEnum.User)" />
                            <span class="custom-radio"></span> INDIVIDUAL
                        </label>
                        <label class="radio-container" style="cursor: pointer; font-weight: 700; font-size: 0.8rem;">
                            <input type="radio" name="role" 
                                   checked="@(_regModel.Role == RolesEnum.Dealer)" 
                                   @onchange="@(() => _regModel.Role = RolesEnum.Dealer)" />
                            <span class="custom-radio"></span> DEALER
                        </label>
                    </div>
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">USERNAME</label>
                    <InputText @bind-Value="_regModel.Username" class="custom-input" placeholder="ALPHA_USER_01" style="width: 100%; border: 2px solid black; padding: 12px; font-weight: 700;" />
                    <ValidationMessage For="@(() => _regModel.Username)" class="user-error" />
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">EMAIL_ADDRESS</label>
                    <InputText @bind-Value="_regModel.Email" type="email" class="custom-input" placeholder="user@domain.com" style="width: 100%; border: 2px solid black; padding: 12px; font-weight: 700;" />
                    <ValidationMessage For="@(() => _regModel.Email)" class="user-error" />
                </div>

                <div class="input-group">
                    <label style="display: block; font-weight: 900; font-size: 0.7rem; margin-bottom: 8px;">SECURITY_KEY (PASSWORD)</label>
                    <InputText @bind-Value="_regModel.Password" type="password" class="custom-input" placeholder="••••••••" style="width: 100%; border: 2px solid black; padding: 12px; font-weight: 700;" />
                    <ValidationMessage For="@(() => _regModel.Password)" class="user-error" />
                </div>

                <button type="submit" class="btn-black" style="margin-top: 10px; padding: 18px; background: black; color: white; border: none; font-weight: 900; cursor: pointer;">
                    EXECUTE_REGISTRATION
                </button>
            </EditForm>
        </div>

        <div style="background: #fafafa; border-top: 2px solid black; padding: 20px; text-align: center;">
            <p style="font-size: 0.7rem; margin: 0; font-weight: 700;">ALREADY REGISTERED? <a href="login" style="color: #ff00ff; text-decoration: none;">SIGN_IN</a></p>
        </div>
    </div>
</div>

<style>
    .user-error { color: #ff0055; font-size: 0.65rem; font-weight: 900; margin-top: 5px; display: block; text-transform: uppercase; }
    .radio-container input { margin-right: 8px; }
</style>

@code {
    private CreateUserDto _regModel = new() { Role = RolesEnum.User };
    private string? _userErrorMessage;

    private async Task HandleRegister()
    {
        _userErrorMessage = null;

        try 
        {
            var payload = new CreateUserDto {
                Username = _regModel.Username,
                Email = _regModel.Email,
                Password = _regModel.Password,
                Role = _regModel.Role
            };

            var response = await Http.PostAsJsonAsync("api/auth/register", payload);
            
            if (response.IsSuccessStatusCode) 
            {
                Nav.NavigateTo("/login");
            }
            else 
            {
                _userErrorMessage = "Information rejected. Possible duplicate identifier or weak password.";
            }
        }
        catch 
        {
            _userErrorMessage = "Terminal failure. Unable to reach registration server.";
        }
    }
}